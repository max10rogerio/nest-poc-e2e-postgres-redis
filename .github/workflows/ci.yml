name: Run Tests

on:
  push:
    branches: [main]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14.1
        env:
          POSTGRES_HOST: 'postgres'
          POSTGRES_DB: 'gazin_seguros_bank_test'
          POSTGRES_USER: 'postgres'
          POSTGRES_PASSWORD: 'postgres'
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn'
      - name: Install puppeteer deps
        run: |
          sudo apt-get update \
          && sudo apt-get install -y wget gnupg \
          && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add - \
          && sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee -a /etc/apt/sources.list.d/google.list' \
          && sudo apt-get update \
          && sudo apt-get install -y google-chrome-stable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1 \
          --no-install-recommends \
          && sudo rm -rf /var/lib/apt/lists/*
      - name: Install yarn deps
        run: yarn
      - name: Run Tests (E2E and Unit)
        run: yarn test:cov --detectOpenHandles
        env:
          NODE_ENV: test
          PORT: 3000
          JEST_JUNIT_OUTPUT_DIR: coverage/
          SENTRY_DSN: https://4e2104755eed46999f007a7dc439fdff@sentry.gazin.com.br//108
          POSTGRES_DATABASE: gazin_seguros_bank_test
          POSTGRES_PORT: ${{ job.services.postgres.ports[5432] }}
          POSTGRES_HOST: postgres
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          REDIS_URI: redis://redis:6379
